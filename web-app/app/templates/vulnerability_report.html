<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      @media print {
        .no-print {
          display: none !important;
        }
        .print-break {
          page-break-before: always;
        }
      }
      .vulnerability-item {
        transition: all 0.2s ease;
      }
      .vulnerability-item:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-900">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
      <!-- Header -->
      <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
        <div class="flex justify-between items-start">
          <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ title }}</h1>
            <p class="text-gray-600">Generated on {{ generated_at }}</p>
            <div class="mt-4">
              <span
                class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800"
              >
                Host: {{ scan.host_name }} ({{ scan.hostname }})
              </span>
              <span
                class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800 ml-2"
              >
                Scan Type: {{ scan.scan_type|title }}
              </span>
              {% if scan.enhanced_analysis_completed %}
              <span
                class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-800 ml-2"
              >
                Enhanced Analysis: Complete
              </span>
              {% endif %}
            </div>
          </div>
          <div class="text-right">
            <div class="text-2xl font-bold text-gray-900">
              {{ summary.total_vulnerabilities }}
            </div>
            <div class="text-sm text-gray-600">Total Vulnerabilities</div>
          </div>
        </div>
      </div>

      <!-- Summary Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow-sm border p-6">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div
                class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center"
              >
                <div class="w-4 h-4 bg-red-600 rounded"></div>
              </div>
            </div>
            <div class="ml-4">
              <div class="text-2xl font-bold text-gray-900">
                {{ summary.critical_count }}
              </div>
              <div class="text-sm text-gray-600">Critical</div>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border p-6">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div
                class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center"
              >
                <div class="w-4 h-4 bg-orange-600 rounded"></div>
              </div>
            </div>
            <div class="ml-4">
              <div class="text-2xl font-bold text-gray-900">
                {{ summary.high_count }}
              </div>
              <div class="text-sm text-gray-600">High</div>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border p-6">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div
                class="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center"
              >
                <div class="w-4 h-4 bg-yellow-600 rounded"></div>
              </div>
            </div>
            <div class="ml-4">
              <div class="text-2xl font-bold text-gray-900">
                {{ summary.medium_count }}
              </div>
              <div class="text-sm text-gray-600">Medium</div>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border p-6">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div
                class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center"
              >
                <div class="w-4 h-4 bg-blue-600 rounded"></div>
              </div>
            </div>
            <div class="ml-4">
              <div class="text-2xl font-bold text-gray-900">
                {{ summary.low_count }}
              </div>
              <div class="text-sm text-gray-600">Low</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts Section -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow-sm border p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">
            Severity Distribution
          </h3>
          <canvas id="severityChart" width="400" height="300"></canvas>
        </div>

        <div class="bg-white rounded-lg shadow-sm border p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">
            Source Distribution
          </h3>
          <canvas id="sourceChart" width="400" height="300"></canvas>
        </div>
      </div>

      <!-- High Risk Packages -->
      {% if package_breakdown %}
      <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
          High Risk Packages
        </h3>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Package
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Total
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Critical
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  High
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Medium
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Low
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Risk Score
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {% for pkg in package_breakdown[:10] %}
              <tr>
                <td
                  class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"
                >
                  {{ pkg.package }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  {{ pkg.total_vulns }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600">
                  {{ pkg.critical }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-orange-600">
                  {{ pkg.high }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-yellow-600">
                  {{ pkg.medium }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">
                  {{ pkg.low }}
                </td>
                <td
                  class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"
                >
                  {{ pkg.risk_score }}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}

      <!-- Vulnerabilities List -->
      <div class="bg-white rounded-lg shadow-sm border p-6 print-break">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
          Vulnerability Details
        </h3>
        <div class="space-y-4">
          {% for vuln in vulnerabilities %}
          <div
            class="vulnerability-item border border-gray-200 rounded-lg p-4 hover:shadow-md"
          >
            <div class="flex justify-between items-start mb-2">
              <div class="flex items-center space-x-3">
                <h4 class="text-lg font-medium text-gray-900">
                  {{ vuln.cve_id }}
                </h4>
                {{ vuln.severity|severity_badge|safe }} {% if vuln.source %}
                <span
                  class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800"
                >
                  {{ vuln.source }}
                </span>
                {% endif %}
              </div>
              <div class="text-right">
                {% if vuln.cvss_score %}
                <div class="text-lg font-bold {{ vuln.cvss_score|cvss_color }}">
                  {{ vuln.cvss_score }}
                </div>
                <div class="text-xs text-gray-500">CVSS Score</div>
                {% endif %}
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
              <div>
                <div class="text-sm text-gray-600">Package</div>
                <div class="font-medium">{{ vuln.affected_package }}</div>
              </div>
              <div>
                <div class="text-sm text-gray-600">Installed Version</div>
                <div class="font-medium">
                  {{ vuln.installed_version or 'Unknown' }}
                </div>
              </div>
              {% if vuln.fixed_version %}
              <div>
                <div class="text-sm text-gray-600">Fixed Version</div>
                <div class="font-medium text-green-600">
                  {{ vuln.fixed_version }}
                </div>
              </div>
              {% endif %} {% if vuln.published_date %}
              <div>
                <div class="text-sm text-gray-600">Published</div>
                <div class="font-medium">
                  {{ vuln.published_date|format_date }}
                </div>
              </div>
              {% endif %}
            </div>

            {% if vuln.title %}
            <div class="mb-2">
              <div class="text-sm text-gray-600">Title</div>
              <div class="text-sm">{{ vuln.title }}</div>
            </div>
            {% endif %} {% if vuln.summary %}
            <div class="mb-2">
              <div class="text-sm text-gray-600">Summary</div>
              <div class="text-sm text-gray-700">{{ vuln.summary }}</div>
            </div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <script>
      // Severity Distribution Chart
      const severityCtx = document.getElementById('severityChart').getContext('2d');
      new Chart(severityCtx, {
          type: 'doughnut',
          data: {
              labels: ['Critical', 'High', 'Medium', 'Low'],
              datasets: [{
                  data: [
                      {{ severity_breakdown.CRITICAL or 0 }},
                      {{ severity_breakdown.HIGH or 0 }},
                      {{ severity_breakdown.MEDIUM or 0 }},
                      {{ severity_breakdown.LOW or 0 }}
                  ],
                  backgroundColor: ['#DC2626', '#EA580C', '#D97706', '#2563EB'],
                  borderWidth: 2,
                  borderColor: '#fff'
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: {
                      position: 'bottom'
                  }
              }
          }
      });

      // Source Distribution Chart
      const sourceCtx = document.getElementById('sourceChart').getContext('2d');
      const sourceLabels = {{ source_breakdown.keys()|list|tojson }};
      const sourceData = {{ source_breakdown.values()|list|tojson }};

      new Chart(sourceCtx, {
          type: 'bar',
          data: {
              labels: sourceLabels,
              datasets: [{
                  label: 'Vulnerabilities',
                  data: sourceData,
                  backgroundColor: '#3B82F6',
                  borderColor: '#1D4ED8',
                  borderWidth: 1
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: {
                      display: false
                  }
              },
              scales: {
                  y: {
                      beginAtZero: true
                  }
              }
          }
      });
    </script>
  </body>
</html>
