{% extends "base_admin.html" %} {% block title %}Enhanced Vulnerability Report - {{
scan.host.name if scan.host else 'Unknown Host' }}{% endblock %}

{% block breadcrumbs %}
<nav class="flex" aria-label="Breadcrumb">
  <ol class="flex items-center space-x-4">
    <li>
      <div>
        <a
          href="/"
          class="text-gray-400 hover:text-gray-500 dark:text-gray-500 dark:hover:text-gray-400"
        >
          <svg
            class="flex-shrink-0 h-5 w-5"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path
              d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"
            ></path>
          </svg>
          <span class="sr-only">Home</span>
        </a>
      </div>
    </li>
    <li>
      <div class="flex items-center">
        <svg
          class="flex-shrink-0 h-5 w-5 text-gray-400"
          fill="currentColor"
          viewBox="0 0 20 20"
        >
          <path
            fill-rule="evenodd"
            d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
            clip-rule="evenodd"
          ></path>
        </svg>
        <a
          href="/reports"
          class="ml-4 text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"
        >
          Reports
        </a>
      </div>
    </li>
    <li>
      <div class="flex items-center">
        <svg
          class="flex-shrink-0 h-5 w-5 text-gray-400"
          fill="currentColor"
          viewBox="0 0 20 20"
        >
          <path
            fill-rule="evenodd"
            d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
            clip-rule="evenodd"
          ></path>
        </svg>
        <span class="ml-4 text-sm font-medium text-gray-500 dark:text-gray-400"
          >Vulnerability Report</span
        >
      </div>
    </li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<div class="space-y-6">
  <!-- Header -->
  <div class="mb-8">
    <div class="flex justify-between items-start">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
          {{ title }}
        </h1>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">
          Generated on {{ generated_at }}
        </p>
        {% if scan.host %}
        <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">
          Host: {{ scan.host.name }} ({{ scan.host.hostname }})
        </p>
        {% endif %}
      </div>
      <div class="flex items-center space-x-3">
        <!-- Export Buttons -->
        <button
          id="export-pdf"
          class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
        >
          <svg
            class="h-4 w-4 mr-2"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"
            ></path>
          </svg>
          Print PDF
        </button>
        <button
          id="export-csv"
          class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
        >
          <svg
            class="h-4 w-4 mr-2"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
            ></path>
          </svg>
          Export CSV
        </button>
      </div>
    </div>
  </div>

  <!-- Executive Summary -->
  <div class="mb-8">
    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">
      Executive Summary
    </h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      <!-- Total Vulnerabilities -->
      <div
        class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg border border-gray-200 dark:border-gray-700"
      >
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <svg
                class="h-6 w-6 text-red-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"
                ></path>
              </svg>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt
                  class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate"
                >
                  Total Vulnerabilities
                </dt>
                <dd class="text-lg font-medium text-gray-900 dark:text-white">
                  {{ summary.total_vulnerabilities }}
                </dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <!-- Packages Affected -->
      <div
        class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg border border-gray-200 dark:border-gray-700"
      >
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <svg
                class="h-6 w-6 text-orange-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
                ></path>
              </svg>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt
                  class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate"
                >
                  Packages Affected
                </dt>
                <dd class="text-lg font-medium text-gray-900 dark:text-white">
                  {{ summary.packages_affected }}
                </dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <!-- Critical Issues -->
      <div
        class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg border border-gray-200 dark:border-gray-700"
      >
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <svg
                class="h-6 w-6 text-red-700"
                fill="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"
                />
              </svg>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt
                  class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate"
                >
                  Critical Issues
                </dt>
                <dd class="text-lg font-medium text-gray-900 dark:text-white">
                  {{ summary.critical_count }}
                </dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <!-- High Priority -->
      <div
        class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg border border-gray-200 dark:border-gray-700"
      >
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <svg
                class="h-6 w-6 text-orange-700"
                fill="currentColor"
                viewBox="0 0 24 24"
              >
                <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z" />
              </svg>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt
                  class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate"
                >
                  High Priority
                </dt>
                <dd class="text-lg font-medium text-gray-900 dark:text-white">
                  {{ summary.high_count }}
                </dd>
              </dl>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="mb-8">
    <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">
      Vulnerability Analytics
    </h2>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- CVSS Distribution Chart -->
      <div
        class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow border border-gray-200 dark:border-gray-700"
      >
        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
          CVSS Score Distribution
        </h3>
        <div
          class="chart-container"
          style="position: relative; height: 300px; width: 100%"
        >
          <canvas id="cvss-chart"></canvas>
        </div>
      </div>

      <!-- Package Risk Chart -->
      <div
        class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow border border-gray-200 dark:border-gray-700"
      >
        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
          Top Risk Packages
        </h3>
        <div
          class="chart-container"
          style="position: relative; height: 300px; width: 100%"
        >
          <canvas id="package-risk-chart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
    <!-- Filters Sidebar -->
    <div class="lg:col-span-1">
      <div
        class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border border-gray-200 dark:border-gray-700 sticky top-4"
      >
        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
          Filters
        </h3>

        <!-- Search -->
        <div class="mb-6">
          <label
            for="search-input"
            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >Search</label
          >
          <input
            type="text"
            id="search-input"
            placeholder="CVE ID, package name..."
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
          />
        </div>

        <!-- Severity Filter -->
        <div class="mb-6">
          <label
            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >Severity</label
          >
          <div class="space-y-2">
            <label class="flex items-center">
              <input
                type="checkbox"
                value="CRITICAL"
                class="severity-filter rounded border-gray-300 dark:border-gray-600 text-red-600 focus:ring-red-500 dark:bg-gray-700"
              />
              <span class="ml-2 text-sm text-gray-700 dark:text-gray-300"
                >Critical</span
              >
              <span
                class="ml-auto inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200"
                >{{ severity_breakdown.CRITICAL or 0 }}</span
              >
            </label>
            <label class="flex items-center">
              <input
                type="checkbox"
                value="HIGH"
                class="severity-filter rounded border-gray-300 dark:border-gray-600 text-orange-600 focus:ring-orange-500 dark:bg-gray-700"
              />
              <span class="ml-2 text-sm text-gray-700 dark:text-gray-300"
                >High</span
              >
              <span
                class="ml-auto inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-200"
                >{{ severity_breakdown.HIGH or 0 }}</span
              >
            </label>
            <label class="flex items-center">
              <input
                type="checkbox"
                value="MEDIUM"
                class="severity-filter rounded border-gray-300 dark:border-gray-600 text-yellow-600 focus:ring-yellow-500 dark:bg-gray-700"
              />
              <span class="ml-2 text-sm text-gray-700 dark:text-gray-300"
                >Medium</span
              >
              <span
                class="ml-auto inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200"
                >{{ severity_breakdown.MEDIUM or 0 }}</span
              >
            </label>
            <label class="flex items-center">
              <input
                type="checkbox"
                value="LOW"
                class="severity-filter rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500 dark:bg-gray-700"
              />
              <span class="ml-2 text-sm text-gray-700 dark:text-gray-300"
                >Low</span
              >
              <span
                class="ml-auto inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200"
                >{{ severity_breakdown.LOW or 0 }}</span
              >
            </label>
          </div>
        </div>

        <!-- CVSS Score Range -->
        <div class="mb-6">
          <label
            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >CVSS Score Range</label
          >
          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-500 dark:text-gray-400"
                >Min: <span id="cvss-min-label">0</span></span
              >
              <span class="text-sm text-gray-500 dark:text-gray-400"
                >Max: <span id="cvss-max-label">10</span></span
              >
            </div>
            <input
              type="range"
              id="cvss-min"
              min="0"
              max="10"
              step="0.1"
              value="0"
              class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer"
            />
            <input
              type="range"
              id="cvss-max"
              min="0"
              max="10"
              step="0.1"
              value="10"
              class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer"
            />
          </div>
        </div>

        <!-- Sort Options -->
        <div class="mb-6">
          <label
            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >Sort By</label
          >
          <div class="grid grid-cols-2 gap-2">
            <button
              data-sort="severity"
              class="sort-btn px-3 py-2 text-xs rounded-md text-white bg-gray-600 hover:bg-gray-700"
            >
              Severity
            </button>
            <button
              data-sort="cvss"
              class="sort-btn px-3 py-2 text-xs rounded-md text-white bg-gray-600 hover:bg-gray-700"
            >
              CVSS Score
            </button>
            <button
              data-sort="date"
              class="sort-btn px-3 py-2 text-xs rounded-md text-white bg-gray-600 hover:bg-gray-700"
            >
              Date
            </button>
            <button
              data-sort="package"
              class="sort-btn px-3 py-2 text-xs rounded-md text-white bg-gray-600 hover:bg-gray-700"
            >
              Package
            </button>
          </div>
        </div>

        <!-- Clear Filters -->
        <button
          id="clear-filters"
          class="w-full px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md"
        >
          Clear All Filters
        </button>

        <!-- Filter Stats -->
        <div class="mt-4 text-sm text-gray-500 dark:text-gray-400 text-center">
          <span id="filter-stats"
            >Showing {{ vulnerabilities|length }} of {{ vulnerabilities|length
            }} vulnerabilities</span
          >
        </div>
      </div>
    </div>

    <!-- Vulnerabilities List -->
    <div class="lg:col-span-3">
      <!-- Package Summary Section -->
      {% if package_breakdown %}
      <div class="mb-8">
        <div class="mb-4 flex justify-between items-center">
          <h2 class="text-xl font-semibold text-gray-900 dark:text-white">
            Package Summary
          </h2>
          <div class="text-sm text-gray-500 dark:text-gray-400">
            Highest vulnerability per package
          </div>
        </div>

        <div class="space-y-3">
          {% for pkg in package_breakdown[:10] %}
          <div
            class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 border border-gray-200 dark:border-gray-700"
          >
            <div class="flex justify-between items-center">
              <div class="flex items-center space-x-3">
                <h3 class="font-medium text-gray-900 dark:text-white">
                  {{ pkg.package }}
                </h3>
                <span class="text-sm text-gray-500 dark:text-gray-400"
                  >{{ pkg.total_vulns }} vulnerabilities</span
                >
              </div>
              <div class="flex space-x-2">
                {% if pkg.critical > 0 %}
                <span
                  class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200"
                >
                  {{ pkg.critical }} Critical
                </span>
                {% endif %} {% if pkg.high > 0 %}
                <span
                  class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-200"
                >
                  {{ pkg.high }} High
                </span>
                {% endif %} {% if pkg.medium > 0 %}
                <span
                  class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200"
                >
                  {{ pkg.medium }} Medium
                </span>
                {% endif %} {% if pkg.low > 0 %}
                <span
                  class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200"
                >
                  {{ pkg.low }} Low
                </span>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <div class="mb-4 flex justify-between items-center">
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white">
          All Vulnerability Details
        </h2>
        <div class="text-sm text-gray-500 dark:text-gray-400">
          Total: {{ vulnerabilities|length }} vulnerabilities
        </div>
      </div>

      <!-- Vulnerabilities Container -->
      <div id="vulnerabilities-container" class="space-y-4">
        {% for vuln in vulnerabilities %}
        <div
          class="vulnerability-item bg-white dark:bg-gray-800 rounded-lg shadow p-6 border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-shadow"
          data-severity="{{ vuln.severity }}"
          data-cvss="{{ vuln.cvss_score or 0 }}"
          data-package="{{ vuln.affected_package }}"
          data-cve="{{ vuln.cve_id }}"
          data-date="{{ vuln.published_date }}"
        >
          <div class="flex justify-between items-start mb-4">
            <div class="flex items-center space-x-3">
              <a
                href="https://www.cve.org/CVERecord?id={{ vuln.cve_id }}"
                target="_blank"
                rel="noopener noreferrer"
                class="text-lg font-semibold text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 hover:underline"
              >
                {{ vuln.cve_id }}
                <svg
                  class="inline w-3 h-3 ml-1"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                  ></path>
                </svg>
              </a>
              {% if vuln.severity %}
              <span
                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if vuln.severity == 'CRITICAL' %}bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200{% endif %} {% if vuln.severity == 'HIGH' %}bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-200{% endif %} {% if vuln.severity == 'MEDIUM' %}bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200{% endif %} {% if vuln.severity == 'LOW' %}bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200{% endif %} {% if vuln.severity not in ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW'] %}bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200{% endif %}"
              >
                {{ vuln.severity }}
              </span>
              {% endif %} {% if vuln.source %}
              <span
                class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200"
              >
                {{ vuln.source }}
              </span>
              {% endif %}
            </div>
            {% if vuln.cvss_score %}
            <div class="text-right">
              <div
                class="text-lg font-bold {% if vuln.cvss_score >= 9.0 %}text-red-600 dark:text-red-400{% endif %} {% if vuln.cvss_score >= 7.0 and vuln.cvss_score < 9.0 %}text-orange-600 dark:text-orange-400{% endif %} {% if vuln.cvss_score >= 4.0 and vuln.cvss_score < 7.0 %}text-yellow-600 dark:text-yellow-400{% endif %} {% if vuln.cvss_score < 4.0 %}text-blue-600 dark:text-blue-400{% endif %}"
              >
                {{ vuln.cvss_score }}
              </div>
              <div class="text-xs text-gray-500 dark:text-gray-400">
                CVSS Score
              </div>
            </div>
            {% endif %}
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <div class="text-sm text-gray-600 dark:text-gray-400">
                Package
              </div>
              <div class="font-medium text-gray-900 dark:text-white">
                {{ vuln.affected_package }}
              </div>
            </div>
            <div>
              <div class="text-sm text-gray-600 dark:text-gray-400">
                Installed Version
              </div>
              <div class="font-medium text-gray-900 dark:text-white">
                {{ vuln.installed_version or 'Unknown' }}
              </div>
            </div>
            {% if vuln.fixed_version %}
            <div>
              <div class="text-sm text-gray-600 dark:text-gray-400">
                Fixed Version
              </div>
              <div class="font-medium text-green-600 dark:text-green-400">
                {{ vuln.fixed_version }}
              </div>
            </div>
            {% endif %} {% if vuln.published_date %}
            <div>
              <div class="text-sm text-gray-600 dark:text-gray-400">
                Published
              </div>
              <div class="font-medium text-gray-900 dark:text-white">
                {{ vuln.published_date.strftime('%Y-%m-%d') if
                vuln.published_date else 'Unknown' }}
              </div>
            </div>
            {% endif %}
          </div>

          {% if vuln.title %}
          <div class="mb-3">
            <div class="text-sm text-gray-600 dark:text-gray-400">Title</div>
            <div class="text-sm text-gray-900 dark:text-white">
              {{ vuln.title }}
            </div>
          </div>
          {% endif %}

          {% if vuln.description %}
          <div class="mb-3">
            <div class="text-sm text-gray-600 dark:text-gray-400">Description</div>
            <div class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed whitespace-pre-line">
              {{ vuln.description|replace(') (CVE-', ')\n\n(CVE-')|replace('Update Instructions:', '\n\nUpdate Instructions:')|replace('No subscription required', '\n\nNo subscription required') }}
            </div>
          </div>
          {% endif %}

          {% if vuln.summary %}
          <div class="mb-3">
            <div class="text-sm text-gray-600 dark:text-gray-400">Summary</div>
            <div class="text-sm text-gray-700 dark:text-gray-300">
              {{ vuln.summary }}
            </div>
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- JavaScript Data -->
<script id="chart-data" type="application/json">
  {
      "cvss_distribution": {
          "0-3": {{ vulnerabilities|selectattr('cvss_score')|selectattr('cvss_score', 'lt', 3)|list|length }},
          "3-5": {{ vulnerabilities|selectattr('cvss_score')|selectattr('cvss_score', 'ge', 3)|selectattr('cvss_score', 'lt', 5)|list|length }},
          "5-7": {{ vulnerabilities|selectattr('cvss_score')|selectattr('cvss_score', 'ge', 5)|selectattr('cvss_score', 'lt', 7)|list|length }},
          "7-9": {{ vulnerabilities|selectattr('cvss_score')|selectattr('cvss_score', 'ge', 7)|selectattr('cvss_score', 'lt', 9)|list|length }},
          "9-10": {{ vulnerabilities|selectattr('cvss_score')|selectattr('cvss_score', 'ge', 9)|list|length }}
      },
      "high_risk_packages": {{ package_breakdown[:10]|tojson if package_breakdown else [] }},
      "severity_distribution": {{ severity_breakdown|tojson }},
      "source_breakdown": {{ source_breakdown|tojson if source_breakdown else {} }}
  }
</script>

<script id="vulnerability-data" type="application/json">
  {{ vulnerabilities|tojson }}
</script>

<script type="text/javascript">
  // Pass data to JavaScript
  window.chartData = JSON.parse(
    document.getElementById("chart-data").textContent,
  );
  window.vulnerabilityData = JSON.parse(
    document.getElementById("vulnerability-data").textContent,
  );

  // Export PDF functionality
  document.getElementById("export-pdf").addEventListener("click", function () {
    window.print();
  });

  // Export CSV functionality
  document.getElementById("export-csv").addEventListener("click", function () {
    const csvContent = generateCSV(window.vulnerabilityData);
    downloadCSV(csvContent, "vulnerability-report.csv");
  });

  function generateCSV(data) {
    const headers = [
      "CVE ID",
      "Severity",
      "CVSS Score",
      "Package",
      "Installed Version",
      "Fixed Version",
      "Published Date",
      "Source",
      "Summary",
    ];
    const rows = data.map((vuln) => [
      vuln.cve_id || "",
      vuln.severity || "",
      vuln.cvss_score || "",
      vuln.affected_package || "",
      vuln.installed_version || "",
      vuln.fixed_version || "",
      vuln.published_date || "",
      vuln.source || "",
      (vuln.summary || "").replace(/"/g, '""'),
    ]);

    const csvContent = [headers, ...rows]
      .map((row) => row.map((field) => `"${field}"`).join(","))
      .join("\n");

    return csvContent;
  }

  function downloadCSV(content, filename) {
    const blob = new Blob([content], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    if (link.download !== undefined) {
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute("download", filename);
      link.style.visibility = "hidden";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  }

  // Store chart instances globally so we can destroy and recreate them
  let cvssChart = null;
  let packageChart = null;

  // Initialize charts and filters when page loads
  document.addEventListener("DOMContentLoaded", function () {
    initializeCharts();
    initializeFilters();

    // Watch for dark mode changes and refresh charts
    const observer = new MutationObserver(function (mutations) {
      mutations.forEach(function (mutation) {
        if (
          mutation.type === "attributes" &&
          mutation.attributeName === "class"
        ) {
          // Check if dark mode class changed
          const isDarkMode =
            document.documentElement.classList.contains("dark");
          // Add a small delay to ensure the transition is complete
          setTimeout(() => {
            refreshCharts();
          }, 100);
        }
      });
    });

    // Start observing the html element for class changes
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["class"],
    });
  });

  function refreshCharts() {
    // Destroy existing charts if they exist
    if (cvssChart) {
      cvssChart.destroy();
    }
    if (packageChart) {
      packageChart.destroy();
    }

    // Reinitialize charts with new theme
    initializeCharts();
  }

  function initializeCharts() {
    // Detect dark mode
    const isDarkMode = document.documentElement.classList.contains("dark");
    const textColor = isDarkMode ? "#E5E7EB" : "#374151";
    const gridColor = isDarkMode ? "#374151" : "#E5E7EB";

    // CVSS Distribution Chart
    const cvssCtx = document.getElementById("cvss-chart").getContext("2d");
    cvssChart = new Chart(cvssCtx, {
      type: "doughnut",
      data: {
        labels: [
          "0-3 (Low)",
          "3-5 (Medium)",
          "5-7 (Medium)",
          "7-9 (High)",
          "9-10 (Critical)",
        ],
        datasets: [
          {
            data: [
              window.chartData.cvss_distribution["0-3"],
              window.chartData.cvss_distribution["3-5"],
              window.chartData.cvss_distribution["5-7"],
              window.chartData.cvss_distribution["7-9"],
              window.chartData.cvss_distribution["9-10"],
            ],
            backgroundColor: [
              "#3B82F6",
              "#F59E0B",
              "#EF4444",
              "#DC2626",
              "#7F1D1D",
            ],
            borderWidth: 2,
            borderColor: isDarkMode ? "#1F2937" : "#fff",
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: "bottom",
            labels: {
              color: textColor,
              font: {
                size: 12,
                weight: "500",
              },
              padding: 15,
              usePointStyle: true,
              pointStyle: "circle",
            },
          },
          tooltip: {
            backgroundColor: isDarkMode ? "#1F2937" : "#FFFFFF",
            titleColor: textColor,
            bodyColor: textColor,
            borderColor: gridColor,
            borderWidth: 1,
            cornerRadius: 8,
            displayColors: true,
          },
        },
      },
    });

    // Package Risk Chart
    const packageCtx = document
      .getElementById("package-risk-chart")
      .getContext("2d");
    const packageLabels = window.chartData.high_risk_packages
      .map((pkg) => pkg.package)
      .slice(0, 8); // Reduce to 8 for better readability
    const packageData = window.chartData.high_risk_packages
      .map((pkg) => pkg.risk_score)
      .slice(0, 8);

    packageChart = new Chart(packageCtx, {
      type: "bar",
      data: {
        labels: packageLabels,
        datasets: [
          {
            label: "Risk Score",
            data: packageData,
            backgroundColor: "#EF4444",
            borderColor: "#DC2626",
            borderWidth: 1,
            borderRadius: 4,
            borderSkipped: false,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false,
          },
          tooltip: {
            backgroundColor: isDarkMode ? "#1F2937" : "#FFFFFF",
            titleColor: textColor,
            bodyColor: textColor,
            borderColor: gridColor,
            borderWidth: 1,
            cornerRadius: 8,
            callbacks: {
              title: function (context) {
                return "Package: " + context[0].label;
              },
              label: function (context) {
                return "Risk Score: " + context.parsed.y;
              },
            },
          },
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              color: textColor,
              font: {
                size: 11,
                weight: "500",
              },
            },
            grid: {
              color: gridColor,
              lineWidth: 1,
            },
            title: {
              display: true,
              text: "Risk Score",
              color: textColor,
              font: {
                size: 12,
                weight: "600",
              },
            },
          },
          x: {
            ticks: {
              color: textColor,
              font: {
                size: 10,
                weight: "500",
              },
              maxRotation: 0,
              minRotation: 0,
              callback: function (value, index, values) {
                const label = this.getLabelForValue(value);
                // Truncate long package names
                return label.length > 12
                  ? label.substring(0, 12) + "..."
                  : label;
              },
            },
            grid: {
              display: false,
            },
            title: {
              display: true,
              text: "Packages",
              color: textColor,
              font: {
                size: 12,
                weight: "600",
              },
            },
          },
        },
      },
    });
  }

  function initializeFilters() {
    const searchInput = document.getElementById("search-input");
    const severityFilters = document.querySelectorAll(".severity-filter");
    const cvssMinSlider = document.getElementById("cvss-min");
    const cvssMaxSlider = document.getElementById("cvss-max");
    const cvssMinLabel = document.getElementById("cvss-min-label");
    const cvssMaxLabel = document.getElementById("cvss-max-label");
    const sortButtons = document.querySelectorAll(".sort-btn");
    const clearFiltersBtn = document.getElementById("clear-filters");
    const filterStats = document.getElementById("filter-stats");

    let currentSort = "severity";
    let currentSortOrder = "desc";

    // Search functionality
    searchInput.addEventListener("input", applyFilters);

    // Severity filters
    severityFilters.forEach((filter) => {
      filter.addEventListener("change", applyFilters);
    });

    // CVSS range sliders
    cvssMinSlider.addEventListener("input", function () {
      cvssMinLabel.textContent = this.value;
      if (parseFloat(this.value) > parseFloat(cvssMaxSlider.value)) {
        cvssMaxSlider.value = this.value;
        cvssMaxLabel.textContent = this.value;
      }
      applyFilters();
    });

    cvssMaxSlider.addEventListener("input", function () {
      cvssMaxLabel.textContent = this.value;
      if (parseFloat(this.value) < parseFloat(cvssMinSlider.value)) {
        cvssMinSlider.value = this.value;
        cvssMinLabel.textContent = this.value;
      }
      applyFilters();
    });

    // Sort buttons
    sortButtons.forEach((button) => {
      button.addEventListener("click", function () {
        const sortType = this.dataset.sort;
        if (currentSort === sortType) {
          currentSortOrder = currentSortOrder === "desc" ? "asc" : "desc";
        } else {
          currentSort = sortType;
          currentSortOrder = "desc";
        }

        // Update button states
        sortButtons.forEach((btn) => btn.classList.remove("bg-blue-600"));
        this.classList.add("bg-blue-600");

        applyFilters();
      });
    });

    // Clear filters
    clearFiltersBtn.addEventListener("click", function () {
      searchInput.value = "";
      severityFilters.forEach((filter) => (filter.checked = false));
      cvssMinSlider.value = 0;
      cvssMaxSlider.value = 10;
      cvssMinLabel.textContent = "0";
      cvssMaxLabel.textContent = "10";
      currentSort = "severity";
      currentSortOrder = "desc";
      sortButtons.forEach((btn) => btn.classList.remove("bg-blue-600"));
      sortButtons[0].classList.add("bg-blue-600");
      applyFilters();
    });

    function applyFilters() {
      const searchTerm = searchInput.value.toLowerCase();
      const selectedSeverities = Array.from(severityFilters)
        .filter((filter) => filter.checked)
        .map((filter) => filter.value);
      const minCvss = parseFloat(cvssMinSlider.value);
      const maxCvss = parseFloat(cvssMaxSlider.value);

      const vulnerabilityItems = document.querySelectorAll(
        ".vulnerability-item",
      );
      let visibleCount = 0;

      // Convert to array for sorting
      const itemsArray = Array.from(vulnerabilityItems);

      // Sort items
      itemsArray.sort((a, b) => {
        let aValue, bValue;

        switch (currentSort) {
          case "severity":
            const severityOrder = {
              CRITICAL: 4,
              HIGH: 3,
              MEDIUM: 2,
              LOW: 1,
              unknown: 0,
            };
            aValue = severityOrder[a.dataset.severity] || 0;
            bValue = severityOrder[b.dataset.severity] || 0;
            break;
          case "cvss":
            aValue = parseFloat(a.dataset.cvss) || 0;
            bValue = parseFloat(b.dataset.cvss) || 0;
            break;
          case "date":
            aValue = new Date(a.dataset.date || 0);
            bValue = new Date(b.dataset.date || 0);
            break;
          case "package":
            aValue = a.dataset.package.toLowerCase();
            bValue = b.dataset.package.toLowerCase();
            break;
          default:
            return 0;
        }

        if (currentSortOrder === "desc") {
          return bValue > aValue ? 1 : bValue < aValue ? -1 : 0;
        } else {
          return aValue > bValue ? 1 : aValue < bValue ? -1 : 0;
        }
      });

      // Apply sorting by reordering DOM elements
      const container = document.getElementById("vulnerabilities-container");
      itemsArray.forEach((item) => container.appendChild(item));

      // Apply filters
      itemsArray.forEach((item) => {
        const severity = item.dataset.severity;
        const cvss = parseFloat(item.dataset.cvss) || 0;
        const packageName = item.dataset.package.toLowerCase();
        const cveId = item.dataset.cve.toLowerCase();

        let visible = true;

        // Search filter
        if (
          searchTerm &&
          !packageName.includes(searchTerm) &&
          !cveId.includes(searchTerm)
        ) {
          visible = false;
        }

        // Severity filter
        if (
          selectedSeverities.length > 0 &&
          !selectedSeverities.includes(severity)
        ) {
          visible = false;
        }

        // CVSS range filter
        if (cvss < minCvss || cvss > maxCvss) {
          visible = false;
        }

        if (visible) {
          item.style.display = "block";
          visibleCount++;
        } else {
          item.style.display = "none";
        }
      });

      // Update filter stats
      filterStats.textContent = `Showing ${visibleCount} of ${vulnerabilityItems.length} vulnerabilities`;
    }

    // Initial application of filters
    applyFilters();
  }
</script>
{% endblock %}
